@using AccountManager.Core.Enums
@using AccountManager.Core.Interfaces
@using AccountManager.Core.Models
@using AccountManager.Core.Services
@using Blazorise.Charts
@inject AppState _state
@inject IValorantGraphService _valorantGraphService

<PieChart @ref="pieChart" Options="pieChartOptions" TItem="PieChartData"></PieChart>

@code {
    [Parameter]
    public Account Account { get; set; }

    
    PieChart<PieChartData>? pieChart;
    PieChartOptions pieChartOptions = new()
    {
        MaintainAspectRatio = false,
        Plugins = new()
        {
            Legend = new()
            {
                Labels = new()
                {
                    Font = new()
                    {
                        Family = "Roboto",
                        Size = 10
                    },
                    BoxHeight = 10,
                    BoxWidth = 16
                },
            },
            Title = new()
            {
                Font = new()
                    {
                        Family = "Roboto",
                        Size = 10
                    },
                Display = true,
                Padding = 1,
                Position = "top"
            }
        }
    };

    async Task HandleRedraw()
    {
        pieChart?.Clear();

        if (pieChart is null)
            return;

        var datasets = displayGraph;
        if (datasets?.Data is null)
            return;

        var chartDatasets = new PieChartDataset<PieChartData>
        {
            Data = datasets?.Data?.ToList(),
            BackgroundColor = backgroundColors,
            BorderColor = borderColors,
        };

        pieChart.AddLabelsDatasetsAndUpdate(datasets?.Labels, chartDatasets);
    }

    protected override async Task OnAfterRenderAsync(bool first)
    {

        if (first)
        {
            _state.UpdateGraphs += async () =>
            {
                displayGraph = await _valorantGraphService.GetRecentlyUsedOperatorsPieChartAsync(Account);
                await HandleRedraw();
            };

            displayGraph = await _valorantGraphService.GetRecentlyUsedOperatorsPieChartAsync(Account);
            pieChartOptions.Plugins.Title.Text = displayGraph?.Title;
            await HandleRedraw();
        }
    }
    private bool showFullTile = false;
    PieChart? displayGraph;

    List<string> backgroundColors = new List<string> { ChartColor.FromRgba(255, 99, 132, 0.2f), ChartColor.FromRgba(54, 162, 235, 0.2f), ChartColor.FromRgba(255, 206, 86, 0.2f), ChartColor.FromRgba(75, 192, 192, 0.2f), ChartColor.FromRgba(153, 102, 255, 0.2f), ChartColor.FromRgba(255, 159, 64, 0.2f) };
    List<string> borderColors = new List<string> { ChartColor.FromRgba(255, 99, 132, 1f), ChartColor.FromRgba(54, 162, 235, 1f), ChartColor.FromRgba(255, 206, 86, 1f), ChartColor.FromRgba(75, 192, 192, 1f), ChartColor.FromRgba(153, 102, 255, 1f), ChartColor.FromRgba(255, 159, 64, 1f) };

}
